Goal: detect that SE Linux is not present without failing if
      --without-selinux or --with-selinux is not specified.

Fix: FTBFS on kfreebsd (and probably The Hurd)

Author: Mike Frysinger <vapier@gentoo.org>

Status wrt upstream: reported by Mike, not applied yet

Index: shadow-4.0.14/configure.in
===================================================================
--- shadow-4.0.14.orig/configure.in	2006-01-03 00:51:44.000000000 +0100
+++ shadow-4.0.14/configure.in	2006-02-09 21:38:45.000000000 +0100
@@ -226,7 +226,7 @@
 	[with_libpam=$withval], [with_libpam=yes])
 AC_ARG_WITH(selinux,
 	[AC_HELP_STRING([--with-selinux], [use SELinux support @<:@default=autodetect@:>@])],
-	[with_selinux=$withval], [with_selinux=yes])
+	[with_selinux=$withval], [with_selinux=maybe])
 AC_ARG_WITH(skey,
 	[AC_HELP_STRING([--with-skey], [use S/Key support @<:@default=no@:>@])],
 	[with_skey=$withval], [with_skey=no])
@@ -288,13 +288,21 @@
 		AC_DEFINE(HAVE_LIBCRACK_PW, 1, [Defined if it includes *Pw functions.]))
 fi
 
-if test "$with_selinux" = "yes"; then
+if test "$with_selinux" != "no"; then
+	have_selinux="yes"
 	AC_CHECK_LIB(selinux, is_selinux_enabled,
 		[LIBSELINUX="-lselinux"],
-		[AC_MSG_ERROR([libselinux not found])])
+		[have_selinux="no"])
 	AC_SUBST(LIBSELINUX)
-	AC_CHECK_HEADERS(selinux/selinux.h, [], [selinux/selinux.h is missing])
-	AC_DEFINE(WITH_SELINUX, 1, [Build shadow with SELinux support])
+	if test "x$have_selinux$with_selinux" = "xnoyes" ; then
+		AC_MSG_ERROR([libselinux not found])
+	elif test "x$have_selinux" = "xyes" ; then
+		with_selinux="yes"
+		AC_CHECK_HEADERS(selinux/selinux.h, [], [selinux/selinux.h is missing])
+		AC_DEFINE(WITH_SELINUX, 1, [Build shadow with SELinux support])
+	else
+		with_selinux="no"
+	fi
 fi
 
 AC_SUBST(LIBPAM)
