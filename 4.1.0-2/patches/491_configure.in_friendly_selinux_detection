Goal: detect that SE Linux is not present without failing if
      --without-selinux or --with-selinux is not specified.

Fix: FTBFS on kfreebsd (and probably The Hurd)

Author: Mike Frysinger <vapier@gentoo.org>

Status wrt upstream: reported by Mike, not applied yet

Index: shadow-4.1.0/configure.in
===================================================================
--- shadow-4.1.0.orig/configure.in
+++ shadow-4.1.0/configure.in
@@ -221,7 +221,7 @@
 	[with_libpam=$withval], [with_libpam=yes])
 AC_ARG_WITH(selinux,
 	[AC_HELP_STRING([--with-selinux], [use SELinux support @<:@default=autodetect@:>@])],
-	[with_selinux=$withval], [with_selinux=yes])
+	[with_selinux=$withval], [with_selinux=maybe])
 AC_ARG_WITH(skey,
 	[AC_HELP_STRING([--with-skey], [use S/Key support @<:@default=no@:>@])],
 	[with_skey=$withval], [with_skey=no])
@@ -292,15 +292,22 @@
 		AC_DEFINE(HAVE_LIBCRACK_PW, 1, [Defined if it includes *Pw functions.]))
 fi
 
-if test "$with_selinux" = "yes"; then
+if test "$with_selinux" != "no"; then
+	have_selinux="yes"
 	AC_CHECK_LIB(selinux, is_selinux_enabled,
 		[LIBSELINUX="-lselinux"
+		],
+		[have_selinux="no"])
+	if test "x$have_selinux$with_selinux" = "xnoyes" ; then
+		AC_MSG_ERROR([libselinux not found])
+	elif test "x$have_selinux" = "xyes" ; then
 		AC_SUBST(LIBSELINUX)
-		AC_CHECK_HEADERS(selinux/selinux.h, [],
-			[AC_MSG_ERROR([selinux/selinux.h is missing])])
+		with_selinux="yes"
+		AC_CHECK_HEADERS(selinux/selinux.h, [], [selinux/selinux.h is missing])
 		AC_DEFINE(WITH_SELINUX, 1, [Build shadow with SELinux support])
-		],
-		[AC_MSG_ERROR([libselinux not found])])
+	else
+		with_selinux="no"
+	fi
 fi
 
 AC_SUBST(LIBPAM)
